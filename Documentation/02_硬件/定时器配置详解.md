# 定时器配置详解

## 概述

本项目使用STM32F103xE的8个定时器中的7个，实现电机控制、编码器读取、舵机驱动、系统时间基和微秒时间戳功能。

**定时器资源分配表**

| 定时器 | 功能 | 时钟源 | 中断优先级 | 状态 |
|--------|------|--------|-----------|------|
| TIM1 | 舵机PWM输出 | APB2 (72MHz) | 无 | 使用中 |
| TIM2 | 编码器A输入 | APB1 (36MHz×2=72MHz) | 无 | 使用中 |
| TIM3 | 编码器B输入 | APB1 (36MHz×2=72MHz) | 无 | 使用中 |
| TIM4 | 编码器C输入 | APB1 (36MHz×2=72MHz) | 无 | 使用中 |
| TIM5 | 编码器D输入 | APB1 (36MHz×2=72MHz) | 无 | 使用中 |
| TIM6 | 系统时间基 (10ms) | APB1 (36MHz×2=72MHz) | 0 (最高) | 使用中 |
| TIM7 | 微秒时间戳 | APB1 (36MHz×2=72MHz) | 0 (最高) | 使用中 |
| TIM8 | 电机PWM输出 | APB2 (72MHz) | 无 | 使用中 |

> **注意**: 当APB预分频≠1时，定时器时钟自动×2。本项目APB1=36MHz，TIM2-7实际时钟为72MHz。

---

## TIM1 - 舵机PWM控制

### 功能描述
- 双路舵机PWM控制（Servo1, Servo2）
- 标准舵机脉宽范围：0.5ms-2.5ms
- PWM频率：50Hz (20ms周期)

### 配置参数
| 参数 | 值 | 说明 |
|------|-----|------|
| 时钟源 | 内部时钟 (APB2: 72MHz) | - |
| 预分频器 (PSC) | 143 | 72MHz / (143+1) = 500kHz |
| 自动重装载值 (ARR) | 9999 | 500kHz / (9999+1) = 50Hz |
| PWM模式 | PWM1 | 向上计数模式 |
| 有效通道 | CH2N, CH3N | 互补输出通道 |
| GPIO引脚 | PB14 (CH2N), PB15 (CH3N) | - |

### PWM脉宽计算
```
脉宽范围: 500us - 2500us
计数值 = 脉宽(us) × 500kHz / 1MHz = 脉宽(us) / 2

示例:
- 0度 (500us)   → 计数值 = 250
- 90度 (1500us) → 计数值 = 750
- 180度 (2500us) → 计数值 = 1250
```

### 代码实现
**初始化** (`Core/Src/tim.c:37-109`):
```c
htim1.Instance = TIM1;
htim1.Init.Prescaler = 143;
htim1.Init.Period = 9999;
htim1.Init.CounterMode = TIM_COUNTERMODE_UP;
HAL_TIM_PWM_Init(&htim1);
HAL_TIMEx_PWMN_Start(&htim1, TIM_CHANNEL_2);
HAL_TIMEx_PWMN_Start(&htim1, TIM_CHANNEL_3);
```

**使用示例** (`USER/ServoControl/servo_control.c:57-77`):
```c
// 设置角度：0-180度
uint16_t pulse = 2000 * angle / 180 + 500;
__HAL_TIM_SetCompare(&htim1, TIM_CHANNEL_3, pulse);  // Servo1
__HAL_TIM_SetCompare(&htim1, TIM_CHANNEL_2, pulse);  // Servo2
```

---

## TIM2-5 - 编码器接口 (四路)

### 功能描述
- 四路正交编码器输入（Motor A/B/C/D）
- 4倍频计数模式（TI12模式）
- 16位计数范围（0-65535）
- 中心值初始化（32767）以支持双向计数

### 配置参数（TIM2/3/4/5相同）
| 参数 | 值 | 说明 |
|------|-----|------|
| 时钟源 | 内部时钟 (APB1: 72MHz) | APB1=36MHz, ×2=72MHz |
| 预分频器 (PSC) | 0 | 不分频 |
| 自动重装载值 (ARR) | 65535 | 16位最大值 |
| 编码器模式 | TI12 | CH1+CH2四倍频 |
| 滤波器 | 0 | 无数字滤波 |
| 极性 | 上升沿 | - |

### GPIO引脚映射
| 定时器 | 电机 | CH1引脚 | CH2引脚 | 备注 |
|--------|------|---------|---------|------|
| TIM2 | Motor A | PA15 (JTDI) | PB3 (JTDO) | 需使用SWD调试 |
| TIM3 | Motor B | PB4 | PB5 | 部分重映射 |
| TIM4 | Motor C | PB6 | PB7 | - |
| TIM5 | Motor D | PA0 (WKUP) | PA1 | - |

### 代码实现
**初始化** (`USER/MotorControl/motor_control.c:76-108`):
```c
// 重置计数器到中间值
TIM2->CNT = ENCODER_MIDDLE;  // 32767
TIM3->CNT = ENCODER_MIDDLE;
TIM4->CNT = ENCODER_MIDDLE;
TIM5->CNT = ENCODER_MIDDLE;

// 启动编码器模式
HAL_TIM_Encoder_Start(&htim2, TIM_CHANNEL_ALL);
HAL_TIM_Encoder_Start(&htim3, TIM_CHANNEL_ALL);
HAL_TIM_Encoder_Start(&htim4, TIM_CHANNEL_ALL);
HAL_TIM_Encoder_Start(&htim5, TIM_CHANNEL_ALL);
```

**速度读取** (`USER/MotorControl/motor_control.c:140-177`):
```c
// 读取当前计数值
current_counter = __HAL_TIM_GET_COUNTER(&htim2);

// 计算增量（带溢出检测）
delta = current_counter - g_encoder_last[0];
if (delta < -32767) {
    delta += 65536;  // 正转溢出
} else if (delta > 32767) {
    delta -= 65536;  // 反转溢出
}

// 重置到中间值
TIM2->CNT = ENCODER_MIDDLE;
```

**方向修正**:
- TIM2: 正方向
- TIM3: **方向相反** (`g_encoder_deltas[1] = -delta1`)
- TIM4: 正方向
- TIM5: **方向相反** (`g_encoder_deltas[3] = -delta3`)

---

## TIM6 - 系统时间基 (10ms任务调度)

### 功能描述
- 100Hz定时中断（10ms周期）
- 提供系统主循环的时间基准
- 协调多任务调度

### 配置参数
| 参数 | 值 | 说明 |
|------|-----|------|
| 时钟源 | 内部时钟 (APB1: 72MHz) | - |
| 预分频器 (PSC) | 71 | 72MHz / (71+1) = 1MHz |
| 自动重装载值 (ARR) | 9999 | 1MHz / (9999+1) = 100Hz |
| 中断频率 | 100Hz | 10ms周期 |
| 中断优先级 | 0 (抢占优先级, 子优先级0) | 最高优先级 |

### 中断处理流程
```
TIM6溢出 (每10ms)
    ↓
TIM6_IRQHandler() (Core/Src/stm32f1xx_it.c:237)
    ↓
HAL_TIM_IRQHandler(&htim6)
    ↓
HAL_TIM_PeriodElapsedCallback() (USER/EXIT/EXIT.c:31)
    ↓
设置标志位 tim6_timeout = 1
    ↓
主循环检测 Judge_Time_OUT() (USER/EXIT/EXIT.c:43)
    ↓
执行周期任务
```

### 任务调度表
**在主循环中** (`Core/Src/main.c:173-205`):
| 周期 | 任务 | 说明 |
|------|------|------|
| 每10ms | Motor_Update() | 电机PID控制 |
| 每10ms | IMU_Update() | 姿态传感器更新 |
| 每10ms | LED_Update() | LED状态更新 |
| 每10ms | IMU_Send() | 发送IMU数据 |
| 每40ms | Motor_Send() | 发送编码器数据 |
| 每200ms | Power_Update() | 电池电压监测 |
| 每200ms | Power_Send() | 发送电池数据 |

### 代码实现
**初始化** (`Core/Src/main.c:120-121`):
```c
HAL_TIM_Base_Init(&htim6);
HAL_TIM_Base_Start_IT(&htim6);  // 使能中断
```

**中断标志处理** (`USER/EXIT/EXIT.c:31-54`):
```c
void HAL_TIM_PeriodElapsedCallback(const TIM_HandleTypeDef *htim)
{
    if(htim->Instance == TIM6) {
        tim6_timeout = 1;
    }
}

uint8_t Judge_Time_OUT(void)
{
    if(tim6_timeout) {
        tim6_timeout = 0;
        return 1;
    }
    return 0;
}
```

**主循环使用** (`Core/Src/main.c:173`):
```c
if (Judge_Time_OUT()) {
    Run_Times++;
    // 执行周期任务...
}
```

---

## TIM7 - 微秒时间戳

### 功能描述
- 32位微秒级时间戳
- 1MHz计数频率（1us/tick）
- 用于测量时间间隔
- 电机控制模块用于动态计算调用周期

### 配置参数
| 参数 | 值 | 说明 |
|------|-----|------|
| 时钟源 | 内部时钟 (APB1: 72MHz) | - |
| 预分频器 (PSC) | 71 | 72MHz / (71+1) = 1MHz |
| 自动重装载值 (ARR) | 65535 | 16位最大值 |
| 溢出周期 | 65536us | ≈65.5ms |
| 中断优先级 | 0 | 最高优先级 |

### 时间戳扩展原理
```
32位时间戳 = [高16位: 软件计数] [低16位: TIM7->CNT]

每次TIM7溢出 (每65.536ms):
    g_time_high16++;

读取时组合:
    timestamp = (g_time_high16 << 16) | TIM7->CNT
```

### 边界情况处理
在读取CNT和g_time_high16之间可能发生溢出：
```c
uint16_t cnt_low = __HAL_TIM_GET_COUNTER(&htim7);
uint16_t high = g_time_high16;

// 如果CNT很小，可能是刚溢出，重新读取高16位
if (cnt_low < 32768) {
    uint16_t high_check = g_time_high16;
    if (high_check != high) {
        high = high_check;
    }
}
```

### 代码实现
**初始化** (`USER/System/timestamp.c:34-40`):
```c
void Time_Init(void) {
    g_time_high16 = 0;
    HAL_TIM_Base_Start_IT(&htim7);
}
```

**获取时间戳** (`USER/System/timestamp.c:57-80`):
```c
uint32_t Time_GetUs(void) {
    uint16_t cnt_low = __HAL_TIM_GET_COUNTER(&htim7);
    uint16_t high = g_time_high16;

    // 溢出检测
    if (cnt_low < 32768) {
        uint16_t high_check = g_time_high16;
        if (high_check != high) {
            high = high_check;
        }
    }

    return ((uint32_t)high << 16) | cnt_low;
}
```

**溢出中断处理** (`USER/System/timestamp.c:91-94`):
```c
void Time_TIM7IRQHandler(void) {
    g_time_high16++;
}
```

**在电机控制中的应用** (`USER/MotorControl/motor_control.c:130-135`):
```c
// 动态计算调用周期
current_time_us = Time_GetUs();
elapsed_us = Time_Elapsed(g_last_update_time_us, current_time_us);
g_last_update_time_us = current_time_us;
g_update_period_ms = elapsed_us / 1000.0f;
```

---

## TIM8 - 电机PWM输出

### 功能描述
- 四路电机PWM控制
- 25kHz PWM频率（超出人耳听觉范围，消除啸叫）
- 12位有效分辨率（0-1439）
- 配合方向GPIO实现H桥控制

### 配置参数
| 参数 | 值 | 说明 |
|------|-----|------|
| 时钟源 | 内部时钟 (APB2: 72MHz) | - |
| 预分频器 (PSC) | 1 | 72MHz / (1+1) = 36MHz |
| 自动重装载值 (ARR) | 1439 | 36MHz / (1439+1) = 25kHz |
| PWM模式 | PWM1 | 向上计数 |
| 有效通道 | CH1, CH2, CH3, CH4 | 四路独立输出 |
| GPIO引脚 | PC6, PC7, PC8, PC9 | 对应Motor A/B/C/D |

### PWM频率计算
```
PWM频率 = 72MHz / ((PSC + 1) × (ARR + 1))
        = 72MHz / (2 × 1440)
        = 25kHz

PWM分辨率 = 1440 级 (≈12位)
PWM精度 = 100% / 1440 ≈ 0.07%
```

### 方向控制 (H桥)
每个电机需要2个GPIO控制方向：

| 电机 | IN1引脚 | IN2引脚 | PWM引脚 |
|------|---------|---------|---------|
| A | MOTOR_A_IN1 | MOTOR_A_IN2 | TIM8_CH1 (PC6) |
| B | MOTOR_B_IN1 | MOTOR_B_IN2 | TIM8_CH2 (PC7) |
| C | MOTOR_C_IN1 | MOTOR_C_IN2 | TIM8_CH3 (PC8) |
| D | MOTOR_D_IN1 | MOTOR_D_IN2 | TIM8_CH4 (PC9) |

| 动作 | IN1 | IN2 | PWM |
|------|-----|-----|-----|
| 停止 | 0 | 0 | 0 |
| 正转 | 1 | 0 | 0-1439 |
| 反转 | 0 | 1 | 0-1439 |

### 代码实现
**初始化** (`USER/MotorControl/motor_control.c:90-93`):
```c
HAL_TIM_PWM_Start(&htim8, TIM_CHANNEL_1);
HAL_TIM_PWM_Start(&htim8, TIM_CHANNEL_2);
HAL_TIM_PWM_Start(&htim8, TIM_CHANNEL_3);
HAL_TIM_PWM_Start(&htim8, TIM_CHANNEL_4);
```

**设置PWM** (`USER/MotorControl/motor_control.c:321-400`):
```c
// 正转示例
HAL_GPIO_WritePin(MOTOR_A_IN1_GPIO_Port, MOTOR_A_IN1_Pin, GPIO_PIN_SET);
HAL_GPIO_WritePin(MOTOR_A_IN2_GPIO_Port, MOTOR_A_IN2_Pin, GPIO_PIN_RESET);
__HAL_TIM_SET_COMPARE(&htim8, TIM_CHANNEL_1, pwm);  // pwm: 0-1439

// 反转示例
HAL_GPIO_WritePin(MOTOR_A_IN1_GPIO_Port, MOTOR_A_IN1_Pin, GPIO_PIN_RESET);
HAL_GPIO_WritePin(MOTOR_A_IN2_GPIO_Port, MOTOR_A_IN2_Pin, GPIO_PIN_SET);
__HAL_TIM_SET_COMPARE(&htim8, TIM_CHANNEL_1, pwm);

// 停止
HAL_GPIO_WritePin(MOTOR_A_IN1_GPIO_Port, MOTOR_A_IN1_Pin, GPIO_PIN_RESET);
HAL_GPIO_WritePin(MOTOR_A_IN2_GPIO_Port, MOTOR_A_IN2_Pin, GPIO_PIN_RESET);
__HAL_TIM_SET_COMPARE(&htim8, TIM_CHANNEL_1, 0);
```

---

## 定时器时钟树

```
         HSE (8MHz)
            ↓
         PLL (×9)
            ↓
        SYSCLK (72MHz)
            ↓
      ┌─────┴─────┐
      ↓           ↓
    AHB         ...
   (72MHz)        ↓
      ↓         APB1 (÷2)
      ↓         (36MHz)
    APB2        ┌──────┐
   (72MHz)      ↓     ↓
      ↓      TIM2-5  TIM6-7
      ↓      (72MHz) (72MHz)
    TIM1/8      ×2     ×2
   (72MHz)      ↓      ↓
      ↓      (72MHz) (72MHz)
   舵机PWM    编码器  时间基
   电机PWM
```

> **重要**: APB1预分频为2，TIM2-7时钟自动×2为72MHz

---

## 中断优先级配置

所有定时器中断使用相同的优先级配置：

| 中断源 | 优先级 | 说明 |
|--------|--------|------|
| TIM6_IRQn | 0, 0 | 系统时间基（最高） |
| TIM7_IRQn | 0, 0 | 微秒时间戳（最高） |

**优先级组**: `NVIC_PRIORITYGROUP_0` (0位抢占优先级，4位子优先级)

---

## 使用建议

### 添加新功能时的定时器选择

1. **需要PWM输出**:
   - 低频PWM (<1kHz): 无可用定时器
   - 高频PWM (1kHz-100kHz): TIM8通道已满，需复用或使用其他外设

2. **需要编码器输入**: TIM2-5已全部使用

3. **需要定时中断**: TIM6已用于系统时间基，TIM7已用于时间戳
   - 可考虑使用软件定时器或修改TIM6任务调度

4. **需要高精度时间测量**: 使用TIM7的`Time_GetUs()`

### 性能优化建议

1. **电机PWM频率**:
   - 当前25kHz已是较好选择
   - 降低频率会增加噪音，提高频率会增加开关损耗

2. **编码器采样率**:
   - 当前40ms周期 (25Hz)
   - 提高采样率可改善PID响应，但增加CPU负载

3. **TIM6任务调度**:
   - 当前10ms基准已足够
   - 如需更高频率任务，可添加倍频器（如%2实现20ms）

### 常见问题

**Q: TIM2编码器引脚与JTAG冲突？**
A: 是的，PA15(JTDI)和PB3(JTDO)是JTAG引脚。解决方法：
- 使用SWD调试接口（PA13/SWDIO, PA14/SWCLK）
- 在代码中启用重映射：`__HAL_AFIO_REMAP_TIM2_PARTIAL_1()`

**Q: 为什么TIM3和TIM5方向相反？**
A: 这是由于编码器安装方向或接线相位差异。在代码中通过取反修正：
```c
g_encoder_deltas[1] = -delta1;  // TIM3
g_encoder_deltas[3] = -delta3;  // TIM5
```

**Q: 如何修改电机PWM频率？**
A: 修改TIM8的预分频器和周期：
```c
// 目标频率 f_target
// 公式: f_target = 72MHz / ((PSC+1) × (ARR+1))
// 示例: 20kHz = 72MHz / (2 × 1800)
htim8.Init.Prescaler = 1;
htim8.Init.Period = 1799;
```

**Q: TIM7时间戳会溢出吗？**
A: 32位时间戳约4295秒（71分钟）溢出一次。
- 对于短期测量（<1小时）无影响
- 对于长期测量，需处理溢出或使用周期计数

---

## 相关文件

| 文件路径 | 说明 |
|----------|------|
| `Core/Src/tim.c` | 定时器初始化和GPIO配置 |
| `Core/Inc/tim.h` | 定时器句柄和函数声明 |
| `Core/Src/stm32f1xx_it.c` | 中断服务函数 |
| `USER/EXIT/EXIT.c` | TIM6中断标志处理 |
| `USER/System/timestamp.c` | TIM7时间戳实现 |
| `USER/MotorControl/motor_control.c` | TIM8 PWM + TIM2-5编码器 |
| `USER/ServoControl/servo_control.c` | TIM1 PWM舵机控制 |
| `Core/Src/main.c` | TIM6任务调度主循环 |

---

**文档版本**: 1.0
**最后更新**: 2026-01-23
**维护者**: RobotChassis Firmware Team
