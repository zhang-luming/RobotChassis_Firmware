# RobotChassis_Firmware 构建说明

## 支持的平台

- **Linux**: Ubuntu, Arch, Fedora, Debian 等
- **macOS**: 通过 Homebrew 安装工具
- **Windows**: PowerShell, Git Bash, MSYS2, WSL

---

## Windows 环境使用

### 方法 1: 使用 PowerShell (推荐)

在 PowerShell 中运行 `build.ps1`：

```powershell
# 构建调试版本
.\build.ps1

# 构建发布版本
.\build.ps1 -Release

# 清理并重新构建
.\build.ps1 -Clean
.\build.ps1 -Release

# 查看帮助
.\build.ps1 -Help

# 构建并烧录
.\build.ps1 -Flash
```

### 方法 2: 使用 Git Bash

在 Git Bash 中运行 `build.sh`：

```bash
# 构建调试版本
./build.sh

# 构建发布版本
./build.sh release

# 清理并重新构建
./build.sh -c && ./build.sh release
```

### 方法 3: 使用 WSL

在 WSL 中使用与 Linux 相同的命令。

---

## Windows 工具链安装

### gcc-arm-none-eabi 工具链

**方式 1: 官方安装包**
- 访问 https://developer.arm.com/downloads/-/gnu-rm
- 下载最新版本的 `gcc-arm-none-eabi`
- 安装后将安装路径添加到系统 PATH

**方式 2: 包管理器**

使用 Scoop:
```cmd
scoop bucket add extras
scoop install gcc-arm-none-eabi
```

使用 Chocolatey:
```cmd
choco install gcc-arm-none-eabi
```

### CMake

**方式 1: 官方安装包**
- 访问 https://cmake.org/download/
- 下载 Windows 安装包并安装
- 安装时选择 "Add CMake to the system PATH"

**方式 2: 包管理器**
```cmd
scoop install cmake
choco install cmake
```

### Ninja (可选，加速构建)

```cmd
scoop install ninja
choco install ninja
```

### OpenOCD (烧录工具)

```cmd
scoop install openocd
choco install openocd
```

---

## 验证安装

打开 PowerShell、CMD 或 Git Bash，运行以下命令验证：

```powershell
# PowerShell / CMD / Git Bash
arm-none-eabi-gcc --version
cmake --version
ninja --version          # 可选
openocd --version        # 可选
```

---

## 输出文件

构建完成后，固件文件位于：

```
build/
├── RobotChassis_Firmware.elf    # 可执行文件 (用于 GDB 调试)
├── RobotChassis_Firmware.map    # 内存映射文件
└── output/
    ├── RobotChassis_Firmware.hex # Intel HEX 格式 (常用烧录格式)
    └── RobotChassis_Firmware.bin  # 纯二进制文件
```

---

## 烧录固件

### 使用 ST-Link 和 OpenOCD

```bash
# Linux/macOS/Git Bash
./build.sh -f

# Windows PowerShell
.\build.ps1 -Flash
```

### 使用 STM32CubeProgrammer (图形界面)

1. 打开 STM32CubeProgrammer
2. 连接 ST-Link
3. 选择 `build/output/RobotChassis_Firmware.hex`
4. 点击 "Connect" 然后 "Program"

---

## 常见问题

### Q: Windows CMD 下提示找不到命令

**A:** 确保已将工具链安装路径添加到系统 PATH 环境变量：
1. 右键 "此电脑" → "属性" → "高级系统设置"
2. 点击 "环境变量"
3. 在 "系统变量" 中找到 `Path`，点击编辑
4. 添加以下路径（根据实际安装位置调整）：
   - `C:\Program Files\arm-none-eabi\bin`
   - `C:\Program Files\CMake\bin`
5. 重启 CMD 或 Git Bash

### Q: Git Bash 中路径格式问题

**A:** 脚本已自动处理路径转换，支持 Windows 和 Unix 风格路径。

### Q: 编译速度慢

**A:** 安装 Ninja 构建工具可显著加速编译：
```cmd
scoop install ninja
```

### Q: WSL 和 Windows 工具链可以混用吗？

**A:** 不建议。WSL 需要安装 Linux 版工具链，Windows 需要 Windows 版工具链。

---

## 命令参考

| 平台 | 命令 | 说明 |
|------|------|------|
| Linux/macOS/Git Bash | `./build.sh` | 构建调试版本 |
| Windows PowerShell | `.\build.ps1` | 构建调试版本 |
| Linux/macOS/Git Bash | `./build.sh release` | 构建发布版本 (优化) |
| Windows PowerShell | `.\build.ps1 -Release` | 构建发布版本 (优化) |
| Linux/macOS/Git Bash | `./build.sh -c` | 清理构建目录 |
| Windows PowerShell | `.\build.ps1 -Clean` | 清理构建目录 |
| Linux/macOS/Git Bash | `./build.sh -f` | 构建并烧录 |
| Windows PowerShell | `.\build.ps1 -Flash` | 构建并烧录 |
| Linux/macOS/Git Bash | `./build.sh -h` | 显示帮助信息 |
| Windows PowerShell | `.\build.ps1 -Help` | 显示帮助信息 |

---

## IDE 集成

### CLion

CLion 可以直接使用现有的 CMake 配置：
1. 打开项目目录
2. CLion 会自动识别 CMakeLists.txt
3. 选择工具链：Settings → Build → Toolchains
4. 添加 "ARM Embedded" 工具链，指向 `arm-none-eabi-gcc`

### Visual Studio Code

安装推荐扩展：
- C/C++ (Microsoft)
- Cortex-Debug
- CMake Tools

配置 `.vscode/settings.json`:
```json
{
    "cmake.configureOnOpen": true,
    "cmake.buildDirectory": "${workspaceFolder}/build",
    "C_Cpp.default.configurationProvider": "ms-vscode.cmake-tools"
}
```
