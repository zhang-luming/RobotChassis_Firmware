# 调试系统使用说明

## 概述

项目采用统一的调试宏系统来控制所有的日志输出，支持分级调试和全局开关。

---

## 调试宏定义

### 文件位置
- 头文件：`USER/System/debug.h`
- 配置文件：`USER/user_config.h`

### 调试级别

| 级别 | 宏定义 | 用途 | 示例 |
|------|--------|------|------|
| INFO | `DEBUG_LEVEL_INFO` | 普通信息（系统状态） | 系统启动、初始化完成 |
| WARN | `DEBUG_LEVEL_WARN` | 警告信息 | 非致命错误、异常情况 |
| ERROR | `DEBUG_LEVEL_ERROR` | 错误信息 | 初始化失败、严重错误 |
| VERBOSE | `DEBUG_LEVEL_VERBOSE` | 详细信息（频繁打印） | 中断统计、传感器数据 |

---

## 使用方法

### 1. 启用调试输出

在 `USER/user_config.h` 中取消注释：

```c
// 启用调试输出
#define DEBUG_ENABLE

// 设置调试级别（可选，默认为VERBOSE）
#define DEBUG_LEVEL DEBUG_LEVEL_VERBOSE
```

### 2. 在代码中使用调试宏

```c
#include "System/debug.h"

// 普通信息
DEBUG_INFO("系统初始化完成\r\n");

// 错误信息
DEBUG_ERROR("初始化失败，错误码: %d\r\n", error_code);

// 警告信息
DEBUG_WARN("电压低于阈值\r\n");

// 详细信息（用于频繁打印）
DEBUG_VERBOSE("中断次数: %lu\r\n", count);
```

### 3. 编译时控制

也可以通过 CMake 编译选项控制：

```bash
# 启用调试输出
cmake -D CMAKE_C_FLAGS="-DDEBUG_ENABLE -DDEBUG_LEVEL=3" ..

# 或者只启用ERROR级别
cmake -D CMAKE_C_FLAGS="-DDEBUG_ENABLE -DDEBUG_LEVEL=2" ..
```

---

## 调试宏说明

### 基础调试宏

```c
DEBUG_PRINTF(fmt, ...)      // 通用调试打印（带[DEBUG]前缀）
DEBUG_INFO(fmt, ...)        // 普通信息（带[INFO]前缀）
DEBUG_WARN(fmt, ...)        // 警告信息（带[WARN]前缀）
DEBUG_ERROR(fmt, ...)       // 错误信息（带[ERROR]前缀）
DEBUG_VERBOSE(fmt, ...)     // 详细信息（带[VERB]前缀）
```

### 辅助调试宏

```c
// 打印当前位置
DEBUG_HERE();

// 打印变量值
DEBUG_VAR(temperature);

// 打印十六进制数据
uint8_t data[16] = {...};
DEBUG_HEX(data, 16);
```

### 断言宏

```c
DEBUG_ASSERT(expr);  // 调试模式下断言，失败时停机
```

---

## 输出格式示例

### INFO 级别
```
[INFO] 系统初始化开始...
[INFO] MPU6050初始化成功
[INFO] MPU INT模块初始化完成，打印间隔: 1000000 us
[INFO] ROS底板开始运行
```

### ERROR 级别
```
[ERROR] MPU6050初始化失败 (错误码:8)
[ERROR]   -> 传感器自检失败 (请确保底盘静止且水平放置)
```

### VERBOSE 级别（中断统计）
```
[VERB] MPU INT 次数:100 频率:100.0Hz 间隔:9990/10000/10010us (最小/当前/最大)
[VERB] MPU INT 次数:200 频率:100.0Hz 间隔:9995/10000/10005us (最小/当前/最大)
```

---

## 已应用调试宏的模块

| 模块 | 文件 | 使用的宏 |
|------|------|----------|
| 主程序 | `Core/Src/main.c` | DEBUG_INFO, DEBUG_ERROR |
| MPU6050驱动 | `USER/IMU/MPU6050/mpu6050.c` | DEBUG_VERBOSE |
| MPU中断 | `USER/IMU/mpu_int.c` | DEBUG_INFO, DEBUG_VERBOSE |

---

## 调试级别选择建议

### 开发阶段
```c
#define DEBUG_ENABLE
#define DEBUG_LEVEL DEBUG_LEVEL_VERBOSE  // 输出所有调试信息
```

### 调试特定问题
```c
#define DEBUG_ENABLE
#define DEBUG_LEVEL DEBUG_LEVEL_INFO    // 只看关键信息
```

### 生产版本
```c
// #define DEBUG_ENABLE  // 禁用所有调试输出，减少代码体积
```

---

## MPU INT 中断调试示例

### 启用中断统计打印

1. 在 `user_config.h` 中配置：
```c
#define DEBUG_ENABLE
#define DEBUG_LEVEL DEBUG_LEVEL_VERBOSE
```

2. 编译并烧录

3. 串口输出示例：
```
[INFO] MPU INT模块初始化完成，打印间隔: 1000000 us
[VERB] MPU INT 次数:100 频率:100.0Hz 间隔:9990/10000/10010us (最小/当前/最大)
[VERB] MPU INT 次数:200 频率:100.0Hz 间隔:9995/10000/10005us (最小/当前/最大)
```

### 数据解读

| 参数 | 说明 | 预期值 |
|------|------|--------|
| 次数 | 累计中断次数 | 持续增加 |
| 频率 | 实际中断频率 | 100Hz（DMP采样率） |
| 间隔(最小) | 最小中断间隔 | ≈9980us |
| 间隔(当前) | 平均中断间隔 | ≈10000us (1/100Hz) |
| 间隔(最大) | 最大中断间隔 | ≈10020us |

**正常范围**：
- 频率：99.5Hz - 100.5Hz
- 间隔：9900us - 10100us

**异常情况**：
- 频率 < 95Hz：可能DMP未正常工作
- 频率 > 105Hz：可能存在干扰触发
- 间隔波动大：系统负载过高或中断冲突

---

## 性能影响

### 调试未启用（`#undef DEBUG_ENABLE`）
- **代码体积**：0字节（所有调试代码被编译器移除）
- **运行时开销**：0
- **RAM占用**：0字节

### 调试启用（`#define DEBUG_ENABLE`）
- **代码体积**：约2-5KB增加
- **运行时开销**：
  - INFO/WARN/ERROR：<10us/次
  - VERBOSE（中断中）：约100us/次
- **RAM占用**：约500字节

### Release 模式建议
```c
// 完全禁用调试，减少Flash和RAM占用
#undef DEBUG_ENABLE
```

---

## 常见问题

### Q: 为什么串口没有输出？
A: 检查以下几点：
1. 确认 `DEBUG_ENABLE` 宏已定义
2. 确认 `RetargetInit(&huart1)` 已调用
3. 确认串口波特率为115200
4. 确认调试级别设置正确（VERBOSE级别才输出中断统计）

### Q: 如何只看错误信息？
A: 设置调试级别为 ERROR：
```c
#define DEBUG_ENABLE
#define DEBUG_LEVEL DEBUG_LEVEL_ERROR
```

### Q: 中断统计为什么每秒只打印一次？
A: 为了避免刷屏，中断统计使用 `DEBUG_VERBOSE` 级别，并在代码中设置了1秒的打印间隔。如需修改间隔，编辑 `mpu_int.c:33`：
```c
static uint32_t g_print_interval_us = 500000;  // 改为0.5秒
```

---

## 相关文档
- `USER/System/debug.h` - 调试宏定义
- `USER/user_config.h` - 调试配置
- `Documentation/IMU中断驱动改造.md` - MPU INT 中断说明

---

**文档版本**：1.0
**最后更新**：2026-01-23
