# æ¨¡å—æ¥å£é‡æ„æ–¹æ¡ˆ v3.0

## é‡æ„æ ¸å¿ƒç†å¿µ

**æ¯ä¸ªæ¨¡å—æä¾›ä¸‰ä¸ªå¯¹å¤–æ¥å£**ï¼š
1. **`xxx_Update()`** - æ›´æ–°æ¨¡å—å†…éƒ¨æ•°æ®ï¼ˆæ¯æ¬¡è°ƒç”¨éƒ½æ‰§è¡Œï¼‰
2. **`xxx_Send()`** - å‘é€æ¨¡å—æ•°æ®ï¼ˆç›´æ¥å‘é€ï¼Œä¸åˆ¤æ–­æ—¶é—´ï¼‰
3. **`xxx_ProcessControl()`** - å¤„ç†æ¥æ”¶åˆ°çš„æ§åˆ¶æŒ‡ä»¤ï¼ˆå¦‚éœ€è¦ï¼‰

**æ—¶é—´æ§åˆ¶ç­–ç•¥**ï¼š
- ä¸»å¾ªç¯ä¸­æ§åˆ¶å„ä¸ªSend()çš„è°ƒç”¨æ—¶æœº
- æ¨¡å—å†…éƒ¨ä¸åˆ¤æ–­æ—¶é—´ï¼Œç›´æ¥æ‰§è¡Œå‘é€
- èŒè´£æ¸…æ™°ï¼šæ¨¡å—è´Ÿè´£åŠŸèƒ½ï¼Œä¸»å¾ªç¯è´Ÿè´£æ—¶åº

---

## æ¨¡å—æ¥å£è®¾è®¡

### 1. Motoræ¨¡å—ï¼ˆç”µæœºæ§åˆ¶ï¼‰

#### æ¥å£å®šä¹‰

```c
/* motor_control.h */

/**
 * @brief åˆå§‹åŒ–ç”µæœºæ§åˆ¶æ¨¡å—
 */
void Motor_Init(void);

/**
 * @brief æ›´æ–°ç”µæœºæ§åˆ¶æ¨¡å—ï¼ˆæ¯10msè°ƒç”¨ï¼‰
 *
 * åŠŸèƒ½ï¼š
 * - è¯»å–ç¼–ç å™¨æ•°æ®
 * - æ‰§è¡ŒPIDæ§åˆ¶
 * - è¾“å‡ºPWM
 *
 * æ³¨æ„ï¼šéœ€è¦åœ¨ä¸»å¾ªç¯ä¸­æ¯æ¬¡è°ƒç”¨
 */
void Motor_Update(void);

/**
 * @brief å‘é€ç”µæœºç¼–ç å™¨æ•°æ®
 *
 * åŠŸèƒ½ï¼š
 * - ç›´æ¥å‘é€ç¼–ç å™¨æ•°æ®åˆ°ä¸Šä½æœº
 * - ä¸åˆ¤æ–­æ—¶é—´ï¼Œç”±ä¸»å¾ªç¯æ§åˆ¶è°ƒç”¨æ—¶æœº
 *
 * æ³¨æ„ï¼šå†…éƒ¨ç›´æ¥è°ƒç”¨Comm_SendEncoder()
 */
void Motor_Send(void);

/**
 * @brief å¤„ç†ç”µæœºé€Ÿåº¦æ§åˆ¶æŒ‡ä»¤
 * @param motor_id ç”µæœºID (0-3)
 * @param speed ç›®æ ‡é€Ÿåº¦
 *
 * åŠŸèƒ½ï¼š
 * - è®¾ç½®ç”µæœºç›®æ ‡é€Ÿåº¦
 * - ä¿å­˜åˆ°å†…éƒ¨çŠ¶æ€
 *
 * æ³¨æ„ï¼šç”±Commæ¨¡å—åœ¨æ¥æ”¶åˆ°é€Ÿåº¦æ§åˆ¶æŒ‡ä»¤æ—¶è°ƒç”¨
 */
void Motor_ProcessSetSpeed(uint8_t motor_id, int16_t speed);

/**
 * @brief å¤„ç†PIDå‚æ•°è®¾ç½®æŒ‡ä»¤
 * @param motor_id ç”µæœºID
 * @param kp På‚æ•°ï¼ˆæ”¾å¤§100å€ï¼‰
 * @param ki Iå‚æ•°ï¼ˆæ”¾å¤§100å€ï¼‰
 * @param kd Då‚æ•°ï¼ˆæ”¾å¤§100å€ï¼‰
 *
 * æ³¨æ„ï¼šç”±Commæ¨¡å—åœ¨æ¥æ”¶åˆ°PIDé…ç½®æŒ‡ä»¤æ—¶è°ƒç”¨
 */
void Motor_ProcessSetPID(uint8_t motor_id, int16_t kp, int16_t ki, int16_t kd);
```

#### å†…éƒ¨å®ç°

```c
/* motor_control.c */

/* ==================== ç§æœ‰å˜é‡ ==================== */
// ç›®æ ‡é€Ÿåº¦
static int16_t g_target_speeds[MOTOR_COUNT] = {0};

// ç¼–ç å™¨æ•°æ®
static int16_t g_encoder_values[MOTOR_COUNT] = {0};
static int16_t g_encoder_last[MOTOR_COUNT] = {32767, 32767, 32767, 32767};
static int16_t g_encoder_deltas[MOTOR_COUNT] = {0};

// PIDå‚æ•°
static int16_t g_kp[MOTOR_COUNT] = {50, 50, 50, 50};
static int16_t g_ki[MOTOR_COUNT] = {10, 10, 10, 10};
static int16_t g_kd[MOTOR_COUNT] = {5, 5, 5, 5};

/* ==================== Updateå®ç° ==================== */
void Motor_Update(void) {
    // 1. è¯»å–å½“å‰ç¼–ç å™¨å€¼
    g_encoder_values[0] = __HAL_TIM_GET_COUNTER(&htim2);
    g_encoder_values[1] = __HAL_TIM_GET_COUNTER(&htim3);
    g_encoder_values[2] = __HAL_TIM_GET_COUNTER(&htim4);
    g_encoder_values[3] = __HAL_TIM_GET_COUNTER(&htim5);

    // 2. è®¡ç®—ç¼–ç å™¨å¢é‡ï¼ˆç›¸å¯¹å€¼ï¼‰
    for (int i = 0; i < MOTOR_COUNT; i++) {
        g_encoder_deltas[i] = g_encoder_values[i] - g_encoder_last[i];
        g_encoder_last[i] = g_encoder_values[i];
    }

    // 3. PIDæ§åˆ¶å¹¶è¾“å‡ºPWM
    for (int i = 0; i < MOTOR_COUNT; i++) {
        int16_t pwm = Motor_PIDControl(i, g_target_speeds[i], g_encoder_deltas[i]);
        Motor_SetSpeed(i, pwm);
    }

    // æ³¨æ„ï¼šè¿™é‡Œä¸æ›´æ–°è®¡æ•°å™¨ï¼Œä¸éœ€è¦åˆ¤æ–­æ—¶é—´
}

/* ==================== Sendå®ç° ==================== */
void Motor_Send(void) {
    // ç›´æ¥å‘é€ï¼Œä¸åˆ¤æ–­æ—¶é—´
    Comm_SendEncoder(g_encoder_values);
}

/* ==================== æ§åˆ¶æŒ‡ä»¤å¤„ç† ==================== */
void Motor_ProcessSetSpeed(uint8_t motor_id, int16_t speed) {
    if (motor_id < MOTOR_COUNT) {
        g_target_speeds[motor_id] = speed;
    }
}

void Motor_ProcessSetPID(uint8_t motor_id, int16_t kp, int16_t ki, int16_t kd) {
    if (motor_id < MOTOR_COUNT) {
        g_kp[motor_id] = kp;
        g_ki[motor_id] = ki;
        g_kd[motor_id] = kd;
    }
}

/* ==================== ç§æœ‰å‡½æ•° ==================== */
static int16_t Motor_PIDControl(uint8_t motor_id, int16_t target, int16_t actual) {
    // PIDç®—æ³•å®ç°...
    return pwm_value;
}

static void Motor_SetSpeed(uint8_t motor_id, int16_t pwm) {
    // PWMé™å¹…
    if (pwm > 1439) pwm = 1439;
    if (pwm < -1439) pwm = -1439;

    // è®¾ç½®PWMå’Œæ–¹å‘
    if (pwm >= 0) {
        // æ­£è½¬
        __HAL_TIM_SET_COMPARE(&htim8, motor_id + TIM_CHANNEL_1, pwm);
        // è®¾ç½®æ–¹å‘å¼•è„š...
    } else {
        // åè½¬
        __HAL_TIM_SET_COMPARE(&htim8, motor_id + TIM_CHANNEL_1, -pwm);
        // è®¾ç½®æ–¹å‘å¼•è„š...
    }
}
```

---

### 2. IMUæ¨¡å—ï¼ˆå§¿æ€æµ‹é‡ï¼‰

#### æ¥å£å®šä¹‰

```c
/* imu_data.h */

/**
 * @brief åˆå§‹åŒ–IMUæ¨¡å—
 * @return 0-æˆåŠŸ, å…¶ä»–-å¤±è´¥
 */
uint8_t IMU_Init(void);

/**
 * @brief æ›´æ–°IMUæ•°æ®ï¼ˆæ¯10msè°ƒç”¨ï¼‰
 *
 * åŠŸèƒ½ï¼š
 * - ä»MPU6050è¯»å–ä¼ æ„Ÿå™¨æ•°æ®
 * - DMPå§¿æ€è§£ç®—
 * - æ•°æ®è½¬æ¢å’Œå­˜å‚¨
 *
 * æ³¨æ„ï¼šéœ€è¦åœ¨ä¸»å¾ªç¯ä¸­æ¯æ¬¡è°ƒç”¨
 */
void IMU_Update(void);

/**
 * @brief å‘é€IMUæ•°æ®
 *
 * åŠŸèƒ½ï¼š
 * - å‘é€æ¬§æ‹‰è§’
 * - å‘é€é™€èºä»ª
 * - å‘é€åŠ é€Ÿåº¦
 *
 * æ³¨æ„ï¼šç›´æ¥å‘é€ï¼Œä¸åˆ¤æ–­æ—¶é—´
 */
void IMU_Send(void);
```

#### å†…éƒ¨å®ç°

```c
/* imu_data.c */

/* ==================== ç§æœ‰å˜é‡ ==================== */
static float g_pitch = 0.0f, g_roll = 0.0f, g_yaw = 0.0f;
static int16_t g_euler_angle[3];  // [pitch, roll, yaw] Ã—100
static int16_t g_gyro[3];         // [gx, gy, gz] Ã—100
static int16_t g_accel[3];        // [ax, ay, az] Ã—100

// åŸå§‹æ•°æ®
static short g_aacx, g_aacy, g_aacz;
static short g_gyrox, g_gyroy, g_gyroz;

/* ==================== Updateå®ç° ==================== */
void IMU_Update(void) {
    // 1. è·å–DMPæ¬§æ‹‰è§’æ•°æ®
    while(mpu_dmp_get_data(&g_pitch, &g_roll, &g_yaw) != 0) {
        // ç­‰å¾…æ•°æ®æœ‰æ•ˆ
    }

    // 2. è·å–åŸå§‹ä¼ æ„Ÿå™¨æ•°æ®
    MPU_Get_Gyroscope(&g_gyrox, &g_gyroy, &g_gyroz);
    MPU_Get_Accelerometer(&g_aacx, &g_aacy, &g_aacz);

    // 3. æ•°æ®è½¬æ¢ï¼ˆÃ—100å­˜å‚¨ï¼‰
    g_euler_angle[0] = g_pitch * 100;
    g_euler_angle[1] = g_roll * 100;
    g_euler_angle[2] = g_yaw * 100;

    g_gyro[0] = (float)(g_gyrox * 0.001064f) * 100;
    g_gyro[1] = (float)(g_gyroy * 0.001064f) * 100;
    g_gyro[2] = (float)(g_gyroz * 0.001064f) * 100;

    g_accel[0] = (float)(g_aacx / 32767.0f) * 2 * G * 100;
    g_accel[1] = (float)(g_aacy / 32767.0f) * 2 * G * 100;
    g_accel[2] = (float)(g_aacz / 32767.0f) * 2 * G * 100;
}

/* ==================== Sendå®ç° ==================== */
void IMU_Send(void) {
    // ç›´æ¥å‘é€æ‰€æœ‰IMUæ•°æ®ï¼Œä¸åˆ¤æ–­æ—¶é—´
    Comm_SendEulerAngle(g_euler_angle);
    Comm_SendGyro(g_gyro);
    Comm_SendAccel(g_accel);
}
```

---

### 3. Poweræ¨¡å—ï¼ˆç”µæºç®¡ç†ï¼‰

#### æ¥å£å®šä¹‰

```c
/* power_management.h */

/**
 * @brief åˆå§‹åŒ–ç”µæºç®¡ç†æ¨¡å—
 */
void Power_Init(void);

/**
 * @brief æ›´æ–°ç”µæ± ç”µå‹ï¼ˆæ¯10msè°ƒç”¨ï¼‰
 *
 * åŠŸèƒ½ï¼š
 * - æ¯200mså¯åŠ¨ADCè½¬æ¢
 * - è¯»å–ç”µå‹å€¼
 * - è½¬æ¢ä¸ºmVå•ä½å¹¶å­˜å‚¨
 *
 * æ³¨æ„ï¼šå†…éƒ¨ä¼šåˆ¤æ–­200msé‡‡æ ·å‘¨æœŸ
 */
void Power_Update(void);

/**
 * @brief å‘é€ç”µæ± ç”µå‹
 *
 * åŠŸèƒ½ï¼š
 * - ç›´æ¥å‘é€ç”µæ± ç”µå‹åˆ°ä¸Šä½æœº
 * - ä¸åˆ¤æ–­æ—¶é—´
 *
 * æ³¨æ„ï¼šéœ€è¦ä¸»å¾ªç¯æ§åˆ¶å‘é€æ—¶æœºï¼ˆæ¯200msï¼‰
 */
void Power_Send(void);
```

#### å†…éƒ¨å®ç°

```c
/* power_management.c */

/* ==================== ç§æœ‰å˜é‡ ==================== */
static uint16_t g_battery_voltage = 0;  // å•ä½ï¼šmV
static uint16_t g_update_counter = 0;

/* ==================== Updateå®ç° ==================== */
void Power_Update(void) {
    g_update_counter++;

    // æ¯200msæ›´æ–°ä¸€æ¬¡ç”µå‹
    if (g_update_counter % 20 == 0) {
        // å¯åŠ¨ADCè½¬æ¢
        HAL_ADC_Start(&hadc2);
        HAL_ADC_PollForConversion(&hadc2, HAL_MAX_DELAY);

        // è¯»å–ADCå€¼
        uint32_t adc_value = HAL_ADC_GetValue(&hadc2);

        // è½¬æ¢ä¸ºç”µå‹ï¼ˆmVï¼‰
        // å‡è®¾3.3Vå‚è€ƒï¼Œ12ä½ADCï¼Œåˆ†å‹ç³»æ•°å¾…å®š
        g_battery_voltage = (adc_value * 3300 / 4095);
    }
}

/* ==================== Sendå®ç° ==================== */
void Power_Send(void) {
    // ç›´æ¥å‘é€ï¼Œä¸åˆ¤æ–­æ—¶é—´
    Comm_SendBatteryVoltage(g_battery_voltage);
}
```

**æ³¨æ„**ï¼šPower_Update()å†…éƒ¨ä»éœ€åˆ¤æ–­é‡‡æ ·æ—¶é—´ï¼ˆå› ä¸ºADCé‡‡æ ·éœ€è¦æ—¶é—´æ§åˆ¶ï¼‰ï¼Œä½†Power_Send()ç›´æ¥å‘é€ã€‚

---

### 4. Servoæ¨¡å—ï¼ˆèˆµæœºæ§åˆ¶ï¼‰

#### æ¥å£å®šä¹‰

```c
/* servo_control.h */

/**
 * @brief åˆå§‹åŒ–èˆµæœºæ§åˆ¶æ¨¡å—
 */
void Servo_Init(void);

/**
 * @brief æ›´æ–°èˆµæœºçŠ¶æ€ï¼ˆé¢„ç•™æ¥å£ï¼‰
 *
 * åŠŸèƒ½ï¼š
 * - èˆµæœºç›®å‰æ˜¯å¼€ç¯æ§åˆ¶ï¼Œæ— éœ€Update
 * - é¢„ç•™ç»™æœªæ¥é—­ç¯æ§åˆ¶ä½¿ç”¨
 */
void Servo_Update(void);

/**
 * @brief å‘é€èˆµæœºçŠ¶æ€ï¼ˆé¢„ç•™æ¥å£ï¼‰
 */
void Servo_Send(void);

/**
 * @brief å¤„ç†èˆµæœºè§’åº¦æ§åˆ¶æŒ‡ä»¤
 * @param servo_id èˆµæœºID (0-1)
 * @param angle è§’åº¦å€¼
 *
 * åŠŸèƒ½ï¼š
 * - è®¾ç½®èˆµæœºè§’åº¦
 * - è¾“å‡ºPWM
 */
void Servo_ProcessSetAngle(uint8_t servo_id, int16_t angle);
```

---

### 5. LEDæ¨¡å—ï¼ˆLEDæ§åˆ¶ï¼‰

#### æ¥å£å®šä¹‰

```c
/* led_control.h */

/**
 * @brief åˆå§‹åŒ–LEDæ¨¡å—
 */
void LED_Init(void);

/**
 * @brief æ›´æ–°LEDçŠ¶æ€ï¼ˆæ¯10msè°ƒç”¨ï¼‰
 */
void LED_Update(void);

/**
 * @brief å‘é€LEDçŠ¶æ€ï¼ˆé¢„ç•™æ¥å£ï¼‰
 */
void LED_Send(void);

/**
 * @brief å¤„ç†LEDçŠ¶æ€è®¾ç½®æŒ‡ä»¤
 * @param state LEDçŠ¶æ€
 */
void LED_ProcessSetState(uint8_t state);
```

---

### 6. Commæ¨¡å—ï¼ˆé€šä¿¡åè®®ï¼‰

#### æ¥å£å®šä¹‰

```c
/* comm_protocol.h */

/**
 * @brief åˆå§‹åŒ–é€šä¿¡æ¨¡å—
 */
void Comm_Init(void);

/**
 * @brief æ›´æ–°é€šä¿¡æ¨¡å—ï¼ˆæ¯10msè°ƒç”¨ï¼‰
 *
 * åŠŸèƒ½ï¼š
 * - å¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®
 * - è§£æåè®®å¸§
 * - åˆ†å‘æ§åˆ¶æŒ‡ä»¤åˆ°å„æ¨¡å—
 */
void Comm_Update(void);

/**
 * @brief å‘é€å‡½æ•°ï¼ˆä¾›å…¶ä»–æ¨¡å—è°ƒç”¨ï¼‰
 */
void Comm_SendEulerAngle(int16_t *euler_angle);
void Comm_SendGyro(int16_t *gyro);
void Comm_SendAccel(int16_t *acc);
void Comm_SendEncoder(int16_t *encoder);
void Comm_SendBatteryVoltage(uint16_t voltage);
```

#### å†…éƒ¨å®ç°

```c
/* comm_protocol.c */

/* ==================== Updateå®ç° ==================== */
void Comm_Update(void) {
    // å¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®
    // åœ¨ä¸­æ–­ä¸­å·²ç»æ¥æ”¶åˆ°å®Œæ•´å¸§

    // åˆ¤æ–­å¸§ç±»å‹å¹¶åˆ†å‘æ§åˆ¶æŒ‡ä»¤
    if (frame_received) {
        uint8_t func_code = g_rx_buffer[1];  // åŠŸèƒ½ç 

        switch(func_code) {
            case 0x06:  // ç”µæœºé€Ÿåº¦æ§åˆ¶
                {
                    uint8_t motor_id = g_rx_buffer[2];
                    int16_t speed = (int16_t)((g_rx_buffer[3] << 8) | g_rx_buffer[4]);
                    Motor_ProcessSetSpeed(motor_id, speed);
                }
                break;

            case 0x07:  // PIDå‚æ•°è®¾ç½®
                {
                    uint8_t motor_id = g_rx_buffer[2];
                    int16_t kp = (int16_t)((g_rx_buffer[3] << 8) | g_rx_buffer[4]);
                    int16_t ki = (int16_t)((g_rx_buffer[5] << 8) | g_rx_buffer[6]);
                    int16_t kd = (int16_t)((g_rx_buffer[7] << 8) | g_rx_buffer[8]);
                    Motor_ProcessSetPID(motor_id, kp, ki, kd);
                }
                break;

            case 0x08:  // èˆµæœºæ§åˆ¶
                {
                    uint8_t servo_id = g_rx_buffer[2];
                    int16_t angle = (int16_t)((g_rx_buffer[3] << 8) | g_rx_buffer[4]);
                    Servo_ProcessSetAngle(servo_id, angle);
                }
                break;

            case 0x09:  // LEDæ§åˆ¶ï¼ˆé¢„ç•™ï¼‰
                {
                    uint8_t state = g_rx_buffer[2];
                    LED_ProcessSetState(state);
                }
                break;
        }
    }
}
```

---

## é‡æ„åçš„ä¸»å¾ªç¯

### å®Œæ•´ä»£ç 

```c
/* main.c - while(1)å¾ªç¯ */
while (1) {
    if (Judge_Time_OUT()) {
        Run_Times++;

        /* ========== ç³»ç»Ÿæ›´æ–°ï¼ˆæ¯æ¬¡éƒ½æ‰§è¡Œï¼‰ ========== */
        LED_Update();           // LEDçŠ¶æ€æ›´æ–°
        Comm_Update();          // å¤„ç†æ¥æ”¶æ•°æ®å¹¶åˆ†å‘æŒ‡ä»¤

        /* ========== æ¨¡å—æ›´æ–°ï¼ˆæ¯æ¬¡éƒ½æ‰§è¡Œï¼‰ ========== */
        Motor_Update();          // ç”µæœºPIDæ§åˆ¶
        IMU_Update();            // æ›´æ–°ä¼ æ„Ÿå™¨æ•°æ®
        Power_Update();          // æ›´æ–°ç”µæ± ç”µå‹ï¼ˆå†…éƒ¨åˆ¤æ–­200msé‡‡æ ·ï¼‰
        Servo_Update();          // é¢„ç•™æ¥å£

        /* ========== æ•°æ®å‘é€ï¼ˆæŒ‰å‘¨æœŸå‘é€ï¼‰ ========== */
        // æ¯10mså‘é€IMUæ•°æ®
        IMU_Send();

        // æ¯40mså‘é€ç¼–ç å™¨æ•°æ®
        if (Run_Times % 4 == 0) {
            Motor_Send();
        }

        // æ¯200mså‘é€ç”µæ± ç”µå‹
        if (Run_Times % 20 == 0) {
            Power_Send();
        }
    }
}
```

### ä»£ç å¯¹æ¯”

**é‡æ„å‰**ï¼ˆ80è¡Œï¼‰ï¼š
```c
if (Judge_Time_OUT()) {
    Run_Times++;
    LED_Update();
    Comm_ProcessControlData();
    IMU_Update();
    {
        int16_t data[3];  // âŒ ä¸»å¾ªç¯åˆ›å»ºä¸´æ—¶å˜é‡
        IMU_GetEulerAngle(data);
        Comm_SendEulerAngle(data);
        IMU_GetGyro(data);
        Comm_SendGyro(data);
        IMU_GetAccel(data);
        Comm_SendAccel(data);
    }
    if (Run_Times % 4 == 0) {
        int16_t encoder_values[4];
        int16_t *encoder_delta;
        int16_t *encoder_target;
        int16_t motor_pwm_val;
        Motor_UpdateEncoderDelta();
        encoder_delta = Motor_GetEncoderDeltaArray();
        encoder_target = Motor_GetTargetSpeedArray();
        motor_pwm_val = Motor_PIDControl(MOTOR_ID_A, ...);
        Motor_SetSpeed(MOTOR_ID_A, motor_pwm_val);
        // ... é‡å¤3æ¬¡
        Motor_GetEncoder(encoder_values);
        Comm_SendEncoder(encoder_values);
    }
}
```

**é‡æ„å**ï¼ˆ20è¡Œï¼‰ï¼š
```c
if (Judge_Time_OUT()) {
    Run_Times++;

    // ç³»ç»Ÿæ›´æ–°
    LED_Update();
    Comm_Update();

    // æ¨¡å—æ›´æ–°
    Motor_Update();
    IMU_Update();
    Power_Update();

    // æ•°æ®å‘é€ï¼ˆæ—¶é—´æ§åˆ¶ï¼‰
    IMU_Send();                    // æ¯æ¬¡
    if (Run_Times % 4 == 0) {
        Motor_Send();              // 40ms
    }
    if (Run_Times % 20 == 0) {
        Power_Send();              // 200ms
    }
}
```

### æ”¹è¿›å¯¹æ¯”

| é¡¹ç›® | é‡æ„å‰ | é‡æ„å | æ”¹å–„ |
|-----|--------|--------|------|
| ä»£ç è¡Œæ•° | ~80è¡Œ | ~20è¡Œ | â†“ 75% |
| ä¸´æ—¶å˜é‡ | 5ä¸ª | 0ä¸ª | â†“ 100% |
| ä»£ç é‡å¤ | 4ä¸ªç”µæœºåˆ†åˆ«è°ƒç”¨ | ç»Ÿä¸€å¤„ç† | æ¶ˆé™¤ |
| æ—¶é—´æ§åˆ¶ | åˆ†æ•£åœ¨æ¨¡å—ä¸­ | é›†ä¸­åœ¨ä¸»å¾ªç¯ | ç»Ÿä¸€ |
| æ¨¡å—èŒè´£ | Update+Sendæ··åˆ | èŒè´£æ¸…æ™° | æ˜ç¡® |

---

## èŒè´£åˆ’åˆ†

### æ¨¡å—èŒè´£

| æ¨¡å— | Update() | Send() | ProcessControl() |
|-----|----------|-------|------------------|
| Motor | ç¼–ç å™¨è¯»å–ã€PIDæ§åˆ¶ã€PWMè¾“å‡º | å‘é€ç¼–ç å™¨æ•°æ® | å¤„ç†é€Ÿåº¦/PIDæŒ‡ä»¤ |
| IMU | ä¼ æ„Ÿå™¨è¯»å–ã€æ•°æ®è½¬æ¢ | å‘é€æ‰€æœ‰ä¼ æ„Ÿå™¨æ•°æ® | - |
| Power | ç”µå‹é‡‡æ ·ï¼ˆæ¯200msï¼‰ | å‘é€ç”µå‹æ•°æ® | - |
| Servo | - | - | å¤„ç†è§’åº¦æŒ‡ä»¤ |
| LED | LEDçŠ¶æ€æ›´æ–° | - | å¤„ç†çŠ¶æ€æŒ‡ä»¤ |
| Comm | è§£ææŒ‡ä»¤ã€è°ƒç”¨Processå‡½æ•° | æä¾›Sendå‡½æ•° | - |

### ä¸»å¾ªç¯èŒè´£

- â° **æ—¶é—´æ§åˆ¶**ï¼šå†³å®šä½•æ—¶è°ƒç”¨Send()
- ğŸ“‹ **è°ƒåº¦ç®¡ç†**ï¼šæŒ‰å›ºå®šé¡ºåºè°ƒç”¨Update()
- ğŸ“¡ **æŒ‡ä»¤åˆ†å‘**ï¼šé€šè¿‡Comm_Update()è°ƒç”¨å„æ¨¡å—Processå‡½æ•°

---

## é‡æ„æ­¥éª¤

### ç¬¬1æ­¥ï¼šMotoræ¨¡å—é‡æ„

**ä»»åŠ¡**ï¼š
1. æ·»åŠ ç§æœ‰å˜é‡å­˜å‚¨çŠ¶æ€
2. å®ç°`Motor_Update()`ï¼šç¼–ç å™¨+PID+PWM
3. å®ç°`Motor_Send()`ï¼šç›´æ¥å‘é€ç¼–ç å™¨
4. å®ç°`Motor_ProcessSetSpeed()`ï¼šè®¾ç½®ç›®æ ‡é€Ÿåº¦
5. å®ç°`Motor_ProcessSetPID()`ï¼šè®¾ç½®PIDå‚æ•°
6. ç§»é™¤å…¬å¼€çš„getterå‡½æ•°ï¼ˆæ”¹ä¸ºstaticï¼‰

**é¢„è®¡æ—¶é—´**ï¼š2å°æ—¶

### ç¬¬2æ­¥ï¼šIMUæ¨¡å—é‡æ„

**ä»»åŠ¡**ï¼š
1. æ·»åŠ ç§æœ‰å˜é‡å­˜å‚¨æ•°æ®
2. å®ç°`IMU_Update()`ï¼šä¼ æ„Ÿå™¨è¯»å–+è½¬æ¢
3. å®ç°`IMU_Send()`ï¼šå‘é€æ‰€æœ‰æ•°æ®
4. ç§»é™¤å…¬å¼€çš„getterå‡½æ•°

**é¢„è®¡æ—¶é—´**ï¼š1.5å°æ—¶

### ç¬¬3æ­¥ï¼šPoweræ¨¡å—é‡æ„

**ä»»åŠ¡**ï¼š
1. æ·»åŠ ç§æœ‰å˜é‡
2. å®ç°`Power_Update()`ï¼šå†…éƒ¨åˆ¤æ–­200msé‡‡æ ·
3. å®ç°`Power_Send()`ï¼šç›´æ¥å‘é€ç”µå‹
4. ç§»é™¤å…¬å¼€çš„getterå‡½æ•°

**é¢„è®¡æ—¶é—´**ï¼š0.5å°æ—¶

### ç¬¬4æ­¥ï¼šCommæ¨¡å—é‡æ„

**ä»»åŠ¡**ï¼š
1. å°†`Comm_ProcessControlData()`æ”¹ä¸º`Comm_Update()`
2. åœ¨Updateä¸­è°ƒç”¨å„æ¨¡å—çš„Processå‡½æ•°
3. ä¿æŒSendå‡½æ•°ä¸å˜

**é¢„è®¡æ—¶é—´**ï¼š1å°æ—¶

### ç¬¬5æ­¥ï¼šLEDå’ŒServoæ¨¡å—é‡æ„

**ä»»åŠ¡**ï¼š
1. LEDï¼šå®ç°`LED_ProcessSetState()`
2. Servoï¼šå®ç°`Servo_ProcessSetAngle()`

**é¢„è®¡æ—¶é—´**ï¼š0.5å°æ—¶

### ç¬¬6æ­¥ï¼šä¸»å¾ªç¯é‡æ„

**ä»»åŠ¡**ï¼š
1. æ›¿æ¢ä¸ºæ–°çš„æ¥å£è°ƒç”¨
2. ç§»é™¤æ‰€æœ‰ä¸´æ—¶å˜é‡
3. æ·»åŠ æ—¶é—´æ§åˆ¶çš„Sendè°ƒç”¨
4. æµ‹è¯•æ‰€æœ‰åŠŸèƒ½

**é¢„è®¡æ—¶é—´**ï¼š1å°æ—¶

**æ€»æ—¶é—´**ï¼š6.5å°æ—¶

---

## æµ‹è¯•æ£€æŸ¥æ¸…å•

### Motoræ¨¡å—

- [ ] `Motor_Update()`æ¯æ¬¡è°ƒç”¨éƒ½æ‰§è¡ŒPIDæ§åˆ¶
- [ ] `Motor_Send()`ç›´æ¥å‘é€ç¼–ç å™¨æ•°æ®
- [ ] `Motor_ProcessSetSpeed()`æ­£ç¡®è®¾ç½®é€Ÿåº¦
- [ ] `Motor_ProcessSetPID()`æ­£ç¡®è®¾ç½®PIDå‚æ•°

### IMUæ¨¡å—

- [ ] `IMU_Update()`æ¯æ¬¡è°ƒç”¨éƒ½æ›´æ–°ä¼ æ„Ÿå™¨
- [ ] `IMU_Send()`æ¯æ¬¡è°ƒç”¨éƒ½å‘é€3ç§æ•°æ®
- [ ] æ•°æ®æ ¼å¼æ­£ç¡®ï¼ˆÃ—100ï¼‰

### Poweræ¨¡å—

- [ ] `Power_Update()`æ¯200msé‡‡æ ·ä¸€æ¬¡
- [ ] `Power_Send()`æ¯æ¬¡è°ƒç”¨éƒ½å‘é€ç”µå‹
- [ ] ç”µå‹å€¼è½¬æ¢æ­£ç¡®

### ä¸»å¾ªç¯é›†æˆ

- [ ] IMUæ•°æ®æ¯10mså‘é€
- [ ] ç¼–ç å™¨æ•°æ®æ¯40mså‘é€
- [ ] ç”µæ± ç”µå‹æ¯200mså‘é€
- [ ] æ§åˆ¶æŒ‡ä»¤æ­£å¸¸å“åº”

---

## æ¨¡å—ä¾èµ–å…³ç³»

### é‡æ„åçš„ä¾èµ–å›¾

```
main.c (æ—¶é—´æ§åˆ¶ä¸­å¿ƒ)
  â†“ è°ƒåº¦
â”œâ”€ Motor_Update()      â†’ æ•°æ®æ›´æ–°
â”œâ”€ IMU_Update()        â†’ æ•°æ®æ›´æ–°
â”œâ”€ Power_Update()      â†’ æ•°æ®æ›´æ–°ï¼ˆå†…éƒ¨åˆ¤æ–­200msé‡‡æ ·ï¼‰
â”œâ”€ LED_Update()        â†’ çŠ¶æ€æ›´æ–°
â”œâ”€ Comm_Update()       â†’ å¤„ç†æŒ‡ä»¤
â””â”€ â””â”€ è°ƒç”¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â†“                â†“
Motor_Send()    Motor_ProcessSetSpeed()   Motor_ProcessSetPID()
IMU_Send()
Power_Send()

Motor / IMU / Power / Servo / LED
  â†“ è°ƒç”¨
Comm_Send*()
```

**ç‰¹ç‚¹**ï¼š
- âœ… å•å‘ä¾èµ–ï¼šæ¨¡å— â†’ Commï¼ˆå‘é€æ•°æ®ï¼‰
- âœ… æ§åˆ¶è§£è€¦ï¼šComm â†’ æ¨¡å—ï¼ˆå¤„ç†æ§åˆ¶ï¼‰
- âœ… æ—¶é—´é›†ä¸­ï¼šä¸»å¾ªç¯ç»Ÿä¸€æ§åˆ¶Sendæ—¶æœº
- âœ… èŒè´£æ¸…æ™°ï¼šæ¨¡å—åªè´Ÿè´£åŠŸèƒ½ï¼Œä¸è´Ÿè´£æ—¶åº

---

## ä»£ç ç¤ºä¾‹ï¼šMotoræ¨¡å—å®Œæ•´é‡æ„

### é‡æ„åçš„motor_control.h

```c
#ifndef __MOTOR_CONTROL_H
#define __MOTOR_CONTROL_H

#include "main.h"

#define MOTOR_ID_A  0
#define MOTOR_ID_B  1
#define MOTOR_ID_C  2
#define MOTOR_ID_D  3
#define MOTOR_COUNT 4

/* æ ¸å¿ƒæ¥å£ */
void Motor_Init(void);
void Motor_Update(void);       // ç¼–ç å™¨+PID+PWM
void Motor_Send(void);         // å‘é€ç¼–ç å™¨

/* æ§åˆ¶æŒ‡ä»¤å¤„ç† */
void Motor_ProcessSetSpeed(uint8_t motor_id, int16_t speed);
void Motor_ProcessSetPID(uint8_t motor_id, int16_t kp, int16_t ki, int16_t kd);

#endif
```

### é‡æ„åçš„motor_control.cï¼ˆæ ¸å¿ƒéƒ¨åˆ†ï¼‰

```c
#include "motor_control.h"
#include "comm_protocol.h"

/* ç§æœ‰å˜é‡ - æ¨¡å—å†…éƒ¨ç»´æŠ¤ */
static int16_t g_target_speeds[MOTOR_COUNT] = {0};
static int16_t g_encoder_values[MOTOR_COUNT] = {0};
static int16_t g_encoder_last[MOTOR_COUNT] = {32767, 32767, 32767, 32767};
static int16_t g_encoder_deltas[MOTOR_COUNT] = {0};

/* Updateå®ç° - æ¯æ¬¡è°ƒç”¨éƒ½æ‰§è¡Œ */
void Motor_Update(void) {
    // 1. è¯»å–ç¼–ç å™¨
    g_encoder_values[0] = __HAL_TIM_GET_COUNTER(&htim2);
    g_encoder_values[1] = __HAL_TIM_GET_COUNTER(&htim3);
    g_encoder_values[2] = __HAL_TIM_GET_COUNTER(&htim4);
    g_encoder_values[3] = __HAL_TIM_GET_COUNTER(&htim5);

    // 2. è®¡ç®—å¢é‡
    for (int i = 0; i < MOTOR_COUNT; i++) {
        g_encoder_deltas[i] = g_encoder_values[i] - g_encoder_last[i];
        g_encoder_last[i] = g_encoder_values[i];
    }

    // 3. PIDæ§åˆ¶å¹¶è¾“å‡ºPWM
    for (int i = 0; i < MOTOR_COUNT; i++) {
        int16_t pwm = calc_pid(i, g_target_speeds[i], g_encoder_deltas[i]);
        set_pwm(i, pwm);
    }
}

/* Sendå®ç° - ç›´æ¥å‘é€ï¼Œä¸åˆ¤æ–­æ—¶é—´ */
void Motor_Send(void) {
    Comm_SendEncoder(g_encoder_values);
}

/* æ§åˆ¶æŒ‡ä»¤å¤„ç† */
void Motor_ProcessSetSpeed(uint8_t motor_id, int16_t speed) {
    if (motor_id < MOTOR_COUNT) {
        g_target_speeds[motor_id] = speed;
    }
}

void Motor_ProcessSetPID(uint8_t motor_id, int16_t kp, int16_t ki, int16_t kd) {
    // æ›´æ–°PIDå‚æ•°åˆ°ç§æœ‰å˜é‡
}

/* ç§æœ‰å‡½æ•° */
static int16_t calc_pid(uint8_t id, int16_t target, int16_t actual) {
    // PIDå®ç°...
    return pwm;
}

static void set_pwm(uint8_t id, int16_t pwm) {
    // PWMè®¾ç½®...
}
```

---

## é‡æ„æ”¶ç›Š

### ä»£ç è´¨é‡

âœ… **ä¸»å¾ªç¯ä»£ç é‡**ï¼šå‡å°‘75%ï¼ˆ80è¡Œ â†’ 20è¡Œï¼‰
âœ… **ä¸»å¾ªç¯ä¸´æ—¶å˜é‡**ï¼šå‡å°‘100%ï¼ˆ5ä¸ª â†’ 0ä¸ªï¼‰
âœ… **ä»£ç é‡å¤**ï¼šå®Œå…¨æ¶ˆé™¤ï¼ˆ4ä¸ªç”µæœºç»Ÿä¸€å¤„ç†ï¼‰
âœ… **æ—¶é—´æ§åˆ¶**ï¼šé›†ä¸­ç®¡ç†ï¼ˆä¸»å¾ªç¯ç»Ÿä¸€æ§åˆ¶ï¼‰

### å¯ç»´æŠ¤æ€§

âœ… **èŒè´£æ¸…æ™°**ï¼š
- Updateï¼šæ•°æ®æ›´æ–°ï¼ˆåŠŸèƒ½ï¼‰
- Sendï¼šæ•°æ®å‘é€ï¼ˆè¾“å‡ºï¼‰
- Processï¼šæ§åˆ¶å¤„ç†ï¼ˆè¾“å…¥ï¼‰

âœ… **æ˜“äºç†è§£**ï¼šSendå‡½æ•°ç›´æ¥å‘é€ï¼Œä¸æ··æ·†

âœ… **æ˜“äºæ‰©å±•**ï¼šæ–°å¢æ¨¡å—åªéœ€å®ç°ä¸‰ä¸ªæ¥å£

âœ… **æ˜“äºæµ‹è¯•**ï¼šæ¯ä¸ªæ¨¡å—å¯ç‹¬ç«‹æµ‹è¯•

### è®¾è®¡ä¼˜åŠ¿

âœ… **æ—¶é—´æ§åˆ¶çµæ´»**ï¼šä¸»å¾ªç¯å¯è‡ªç”±è°ƒæ•´å‘é€é¢‘ç‡
âœ… **æ¨¡å—çº¯ç²¹**ï¼šæ¨¡å—ä¸å…³å¿ƒæ—¶é—´ï¼ŒåªåšåŠŸèƒ½
âœ… **è°ƒè¯•æ–¹ä¾¿**ï¼šå¯ä»¥å•ç‹¬æµ‹è¯•æŸä¸ªSendå‡½æ•°

---

## å®æ–½å»ºè®®

1. **å…ˆé‡æ„Motoræ¨¡å—**ï¼ˆæœ€å¤æ‚ï¼Œæ”¶ç›Šæœ€å¤§ï¼‰
2. **å†é‡æ„IMUæ¨¡å—**ï¼ˆæ¬¡å¤æ‚ï¼‰
3. **ç„¶åé‡æ„Powerå’ŒCommæ¨¡å—**ï¼ˆç›¸å¯¹ç®€å•ï¼‰
4. **æœ€åé‡æ„ä¸»å¾ªç¯**ï¼ˆæ›¿æ¢ä¸ºæ–°æ¥å£ï¼‰

2. **æ¯ä¸ªæ¨¡å—é‡æ„å**ï¼š
   - ç¼–è¯‘æµ‹è¯•
   - åŠŸèƒ½æµ‹è¯•
   - Gitæäº¤

è¿™æ ·é‡æ„åçš„ä»£ç å°†éå¸¸æ¸…æ™°ã€æ˜“ç»´æŠ¤ï¼
