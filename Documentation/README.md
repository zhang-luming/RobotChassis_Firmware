# RobotChassis 固件系统架构

## 系统概述

本项目是基于STM32F103xE的四轮机器人底盘固件，实现电机控制、IMU姿态测量、舵机控制和串口通信功能。

**硬件平台**：STM32F103xE (72MHz, 512KB Flash, 64KB RAM)

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        应用层 (Application Layer)                │
├─────────────────────────────────────────────────────────────┤
│  主循环 (10ms时基)                                            │
│  ├─ LED状态更新                                             │
│  ├─ 通信数据处理                                           │
│  ├─ 电机PID控制 (每10ms)                                   │
│  ├─ 电池电压监测 (每200ms)                                 │
│  └─ 舵机控制                                               │
├─────────────────────────────────────────────────────────────┤
│              驱动抽象层 (Driver Wrapper Layer)                  │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ 电机控制模块 │  │ IMU数据模块  │  │  舵机控制模块  │  │
│  └─────────────┘  └───────────┘  └──────────────┘  │
│  ┌─────────────┐  ┌──────────┐  ┌──────────┐  ┌───────┐ │
│  │通信协议模块  │  │电源管理  │  │LED控制   │  │时间戳│ │
│  └─────────────┘  └──────────┘  └──────────┘  └───────┘ │
├─────────────────────────────────────────────────────────────┤
│                     HAL层 (Core/)                           │
├─────────────────────────────────────────────────────────────┤
│  TIM1(舵机PWM) │ TIM2-5(编码器) │ TIM6(时基) │ TIM8(电机PWM) │
│  USART1(调试)  │ USART2(通信) │   ADC1(电池)    │            │
├─────────────────────────────────────────────────────────────┤
│                   硬件层 (Hardware)                           │
├─────────────────────────────────────────────────────────────┤
│  STM32F103xE                                              │
│  • 4× 电机驱动器 + 8× GPIO方向控制                             │
│  • MPU6050 (I2C - GPIO bit-bang)                                │
│  • 2× 舵机 (PWM)                                             │
│  • 4× 编码器 (定时器2/3/4/5)                                     │
│  • 2× 串口 (调试+通信)                                         │
└─────────────────────────────────────────────────────────────┘
```

## 核心功能模块

### 1. 电机控制系统
- **功能**：四路电机PID速度控制
- **硬件**：4×编码器 + 4×电机驱动
- **控制方式**：中断驱动（MPU6050 INT触发，100Hz）
- **PWM频率**：25kHz（TIM8，避免啸叫）
- **更新频率**：每10ms执行PID控制

### 2. 姿态测量系统 (IMU)
- **传感器**：MPU6050 (陀螺仪 + 加速度计 + DMP)
- **接口**：I2C (GPIO bit-bang, PB12-SCL, PB13-SDA)
- **输出**：欧拉角（俯仰/横滚/航向）、陀螺仪、加速度
- **更新频率**：100Hz（DMP中断驱动）

### 3. 舵机控制系统
- **功能**：双路舵机PWM控制
- **PWM频率**：50Hz（标准舵机频率）
- **脉宽范围**：0.5ms-2.5ms（对应0-180度）
- **输出通道**：TIM1 CH2N/CH3N → PB14/15

### 4. 串口通信
- **USART1 (PA9/PA10)**：调试输出（115200bps）
- **USART2 (PA2/PA3)**：数据通信（115200bps）
- **协议格式**：[0xFC][功能码][数据10字节][XOR校验][0xDF]
- **通信方式**：中断驱动接收

### 5. 电源管理
- **功能**：电池电压监测
- **硬件**：ADC2 Channel 8 (PB0)
- **更新频率**：每200ms

## 定时器资源分配

| 定时器 | 功能 | 频率/周期 | 用途 |
|--------|------|-----------|------|
| **TIM1** | 舵机PWM | 50Hz (20ms) | 双路舵机控制 |
| **TIM2-5** | 编码器输入 | - | 四路正交编码器 |
| **TIM6** | 系统时基 | 100Hz (10ms) | 主循环任务调度 |
| **TIM7** | 微秒时间戳 | 1MHz | 高精度时间测量 |
| **TIM8** | 电机PWM | 25kHz | 四路电机速度控制 |

> 详细配置见 `02_硬件/定时器配置详解.md`

## 中断系统

### 中断优先级配置
所有关键中断使用优先级 0（最高抢占优先级）：

| 中断源 | 优先级 | 触发频率 |
|--------|--------|----------|
| EXTI15_10 (MPU INT) | 0,0 | 100Hz |
| TIM6 (系统时基) | 0,0 | 100Hz |
| TIM7 (时间戳) | 0,0 | 65.5ms溢出 |
| USART2 (通信) | 0,0 | 按需触发 |

### 中断触发方式
- **MPU6050 INT**：下降沿触发，PC12连接
- **TIM6**：定时溢出，每10ms触发主循环
- **TIM7**：定时溢出，每65.5ms更新时间戳高位

## 数据流

### IMU数据流
```
MPU6050 DMP → INT引脚 → EXTI中断 → MPU_INT_IRQHandler()
                                            ↓
                                    I2C读取DMP数据
                                            ↓
                                    USART2发送（36字节/次）
```

### 电机控制数据流
```
主循环 (10ms)
    ↓
Motor_Update()
    ├─ TIM2-5 读取编码器 (带溢出检测)
    ├─ PID计算 (目标速度 vs 实际速度)
    └─ TIM8 输出PWM + GPIO方向控制
```

### 串口通信数据流
```
上位机 → USART2 → Comm_Update() → 分发到各模块
各模块 → USART2 → Comm_Send*() → 上位机
```

## 内存使用

| 资源 | 使用量 | 总量 | 占用率 |
|------|--------|------|--------|
| Flash | ~50KB | 512KB | ~10% |
| RAM | ~10KB | 64KB | ~16% |
| 定时器 | 7/8 | 8 | 87.5% |
| GPIO | ~32/64 | 64 | 50% |

## 文档组织

```
Documentation/
├── README.md (本文件 - 系统总体架构)
│
├── 01_系统/                    (系统级文档)
│   ├── 构建说明.md
│   └── Git使用指南.md
│
├── 02_硬件/                    (硬件配置文档)
│   ├── Core外设配置速查表.md
│   ├── 定时器配置详解.md
│   └── Core外设配置详解.md
│
├── 03_IMU/                     (IMU模块文档)
│   ├── MPU6050_IMU架构详解.md
│   └── MPU_INT配置总结.md
│
├── 04_电机/                    (电机控制文档)
│   └── 电机控制模块详解.md
│
├── 05_通信/                    (通信模块文档)
│   └── (待添加)
│
├── 06_调试/                    (调试工具文档)
│   └── 调试系统使用说明.md
│
└── 知识点/                     (技术知识点文档)
    ├── 01-DMA工作机制.md
    ├── 02-DMP固件加载原理.md
    └── (待添加)
```

## 相关文件

- 项目根目录：`README.md`
- 模块说明：`USER/README.md`
- 系统配置：`USER/user_config.h`
- 构建配置：`CMakeLists.txt`, `CMakePresets.json`

---

**版本**：1.0
**最后更新**：2026-01-24
**维护者**：RobotChassis Firmware Team
